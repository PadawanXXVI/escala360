{% extends "base.html" %}
{% block title %}Auditoria do Sistema ‚Äì Escala360{% endblock %}

{% block content %}
<section class="page-section fade-in max-w-6xl mx-auto my-8">
  <header class="mb-6">
    <h1 class="text-2xl font-semibold text-indigo-700 dark:text-indigo-300 flex items-center gap-2">
      <i class="fas fa-file-alt"></i> Auditoria do Sistema
    </h1>
    <p class="text-gray-600 dark:text-gray-400">
      Consulte e analise todas as a√ß√µes realizadas no sistema, incluindo cria√ß√µes, atualiza√ß√µes e exclus√µes.
    </p>
  </header>

  <!-- üîç Filtros -->
  <form id="filtro-auditoria" class="bg-white dark:bg-gray-800 shadow-md rounded-xl p-6 space-y-4">
    <div class="grid md:grid-cols-4 gap-4">
      <div>
        <label for="usuario" class="label">Usu√°rio</label>
        <input type="text" id="usuario" name="usuario" class="input" placeholder="Nome ou e-mail">
      </div>
      <div>
        <label for="modulo" class="label">M√≥dulo</label>
        <select id="modulo" name="modulo" class="input">
          <option value="">Todos</option>
          <option value="Profissionais">Profissionais</option>
          <option value="Plant√µes">Plant√µes</option>
          <option value="Escalas">Escalas</option>
          <option value="Substitui√ß√µes">Substitui√ß√µes</option>
        </select>
      </div>
      <div>
        <label for="data_inicio" class="label">De</label>
        <input type="date" id="data_inicio" name="data_inicio" class="input">
      </div>
      <div>
        <label for="data_fim" class="label">At√©</label>
        <input type="date" id="data_fim" name="data_fim" class="input">
      </div>
    </div>
    <div class="flex justify-end pt-2">
      <button type="submit" class="btn-primary">
        <i class="fas fa-search"></i> Aplicar Filtros
      </button>
    </div>
  </form>

  <!-- üìã Tabela -->
  <div class="mt-10">
    <h2 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300 flex items-center gap-2">
      <i class="fas fa-history"></i> Registros de Auditoria
    </h2>
    <div class="overflow-x-auto rounded-xl shadow-md">
      <table id="tabela-auditoria" class="w-full text-sm">
        <thead class="bg-indigo-600 text-white">
          <tr>
            <th class="px-4 py-2 text-left">Data / Hora</th>
            <th class="px-4 py-2 text-left">Usu√°rio</th>
            <th class="px-4 py-2 text-left">M√≥dulo</th>
            <th class="px-4 py-2 text-left">A√ß√£o</th>
            <th class="px-4 py-2 text-left">Descri√ß√£o</th>
          </tr>
        </thead>
        <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
          <tr>
            <td colspan="5" class="text-center py-4 text-gray-400">
              Nenhum registro encontrado.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- üîß Script inline (Consulta de Auditoria) -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const tabela = document.querySelector("#tabela-auditoria tbody");
  const filtro = document.getElementById("filtro-auditoria");

  filtro.addEventListener("submit", (e) => {
    e.preventDefault();
    carregarAuditoria();
  });

  async function carregarAuditoria() {
    const params = new URLSearchParams({
      usuario: filtro.usuario.value,
      modulo: filtro.modulo.value,
      data_inicio: filtro.data_inicio.value,
      data_fim: filtro.data_fim.value,
    });

    try {
      const res = await fetch(`/auditoria/api?${params.toString()}`);
      const data = await res.json();

      tabela.innerHTML = data.length
        ? data
            .map(
              (a) => `
          <tr class="hover:bg-indigo-50 dark:hover:bg-indigo-900 transition">
            <td class="px-4 py-2">${a.data_hora}</td>
            <td class="px-4 py-2">${a.usuario || "‚Äî"}</td>
            <td class="px-4 py-2">${a.modulo}</td>
            <td class="px-4 py-2 font-semibold ${
              a.acao === "CREATE"
                ? "text-green-600"
                : a.acao === "UPDATE"
                ? "text-yellow-600"
                : "text-red-600"
            }">${a.acao}</td>
            <td class="px-4 py-2">${a.descricao}</td>
          </tr>`
            )
            .join("")
        : `<tr><td colspan="5" class="text-center py-4 text-gray-400">Nenhum registro encontrado.</td></tr>`;
    } catch (err) {
      console.error(err);
      toast("‚ö†Ô∏è Erro ao carregar registros de auditoria.");
    }
  }

  carregarAuditoria();
});
</script>
{% endblock %}
